"""
Synchronous Temperature-Stabilized Data Collection (PID Only Timing)
===================================================================================
This script controls a TC-720 temperature controller and a Keysight P5027A VNA.
- Uses Normal Set Mode (mode 0, PID Control) for the entire process.
- Python handles the Unified Soak/Stability timing loop, which is the only reliable 
  way to hold stability at a user-defined target without risking Mode 1 overshoot.
- Includes a Critical Timeout with Manual Override (-511) to break thermal stalls.
"""

import csv
import time
import json
import threading
from datetime import datetime
import os
import sys
import pyvisa as visa

# --- Configuration (Defaults & Constants) ---
SAMPLING_INTERVAL_SECONDS = 5  # Temperature logging interval
NUM_POINTS = 201  # Number of sweep points per VNA acquisition
TEMP_TOLERANCE = 1  # Temperature stability tolerance (¬±¬∞C)
MAX_OUTPUT_COOLING = -511 # 100% cooling power (based on Py_TC720.py range)
MANUAL_FLUSH_DURATION = 30 # Seconds to force max cooling on timeout (fixed pulse)

# --- Global Variables ---
vna_sweep_count = 0
experiment_start_time = None 
keyboard_interrupt_count = 0 

# --- Helper Function for Time Formatting ---
def format_elapsed_time(seconds):
    """Convert seconds to human-readable format (HH:MM:SS)"""
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    secs = int(seconds % 60)
    return f"{hours:02d}:{minutes:02d}:{secs:02d}"

# --- 1. Setup Script Directory ---
script_path = os.path.abspath(__file__)
script_dir = os.path.dirname(script_path)
os.chdir(script_dir)
print(f"Current Working Directory: {os.getcwd()}")

# --- 2. Import TC-720 Library ---
try:
    import Py_TC720
except ImportError:
    print("‚ùå Error: Py_TC720.py library not found. Please ensure it's in the same directory.")
    sys.exit(1)

# --- 3. Setup Experiment Directory ---
def setup_experiment_directory():
    """Create organized directory structure for this experiment"""
    timestamp_str = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    # Create main experiments folder if it doesn't exist
    experiments_base = os.path.join(script_dir, "experiments")
    os.makedirs(experiments_base, exist_ok=True)
    
    # Create this specific experiment folder
    exp_dir = os.path.join(experiments_base, f"experiment_{timestamp_str}")
    sweep_dir = os.path.join(exp_dir, "sweep_data")
    os.makedirs(sweep_dir, exist_ok=True)
    
    return exp_dir, sweep_dir, timestamp_str

# --- 4. Get User Input for Temperature Profile ---
def get_temperature_profile():
    """Prompt user for targets, unified stability/soak time, and ramp timeout"""
    
    # 1. Get Target Temperatures
    while True:
        try:
            num_temps = int(input("\nHow many target temperatures?: "))
            if num_temps >= 1:
                break
            print("Please enter 1 or more target temperatures.")
        except ValueError:
            print("Invalid input. Please enter an integer.")
    
    temps = []
    for i in range(num_temps):
        while True:
            try:
                temp = float(input(f"Target Temperature {i+1} (¬∞C): "))
                temps.append(temp)
                break
            except ValueError:
                print("Invalid input. Please enter a number.")
    
    # 2. Get Unified Stability/Soak Duration (Pre-VNA)
    print("\n--- Stability & Timing Settings ---")
    while True:
        try:
            # UNIFIED TIME INPUT
            stability_soak_min = float(input(f"Required STABILITY/SOAK duration (minutes, e.g., 8): "))
            if stability_soak_min > 0:
                break
            print("Duration must be positive.")
        except ValueError:
            print("Invalid input. Please enter a number.")
            
    # 3. Get Ramp Timeout
    while True:
        try:
            ramp_timeout_min = float(input(f"Maximum time to reach stability (minutes, e.g., 30): "))
            if ramp_timeout_min > 0:
                break
            print("Timeout must be positive.")
        except ValueError:
            print("Invalid input. Please enter a number.")
    
    return temps, stability_soak_min, ramp_timeout_min

# --- 5. Initialize Devices (PID Mode Only) ---
def initialize_devices():
    """Initialize TC-720 and VNA in PID Mode 0 only"""
    
    # Initialize TC-720
    COM_PORT = Py_TC720.find_address()
    if hasattr(COM_PORT, 'device'):
        COM_PORT = COM_PORT.device
    
    try:
        # Set mode to 0 (Normal Set) with control_type 0 (PID temperature control)
        # This is the only mode used throughout the experiment
        tc720 = Py_TC720.TC720(address=COM_PORT, mode=0, control_type=0)
        print(f"‚úÖ TC-720 connected on {COM_PORT}")
        print(f"   Mode: Normal Set (PID Control) - Used for all ramping and holding.")
        
    except Exception as e:
        print(f"‚ùå Error connecting to TC-720: {e}")
        return None, None
    
    # Initialize VNA
    try:
        rm = visa.ResourceManager()
        print("Available VISA Resources:", rm.list_resources())
        # Replace with your VNA's address
        vna = rm.open_resource('TCPIP0::DESKTOP-N8PF739::hislip_PXI10_CHASSIS1_SLOT1_INDEX0::INSTR')
        print(f"‚úÖ VNA connected: {vna.query('*IDN?').strip()}")
        
        # Configure VNA
        vna.write(f':SENSe:SWEep:POINts {NUM_POINTS}')
        vna.write(':SENSe:SWEep:MODE HOLD') 
        vna.write(':FORMat:DATA ASCII')
        
    except Exception as e:
        print(f"‚ùå Error connecting to VNA: {e}")
        return tc720, None
    
    return tc720, vna

# --- 6. Synchronous VNA Sweep Function ---
def perform_vna_sweep(vna, sweep_dir, current_temp, current_step_idx):
    """Performs a single VNA sweep synchronously"""
    global vna_sweep_count, experiment_start_time
    
    vna_sweep_count += 1
    sweep_num = vna_sweep_count
    
    collection_time = datetime.now()
    timestamp_str = collection_time.strftime("%Y%m%d_%H%M%S")
    
    elapsed_seconds = time.time() - experiment_start_time
    elapsed_formatted = format_elapsed_time(elapsed_seconds)
    
    try:
        # Trigger sweep and query data
        vna.write(':TRIGger:SEQuence:SINGle')
        vna.query('*OPC?') # Wait for sweep completion
        
        # Query VNA data
        temp_values = vna.query_ascii_values('CALCulate:DATA:SNP? 1')
        total_len = len(temp_values)
        points_per_var = total_len // 3
        
        freq = temp_values[0:points_per_var]
        real = temp_values[points_per_var:2*points_per_var]
        imag = temp_values[2*points_per_var:3*points_per_var]
        
        # Create filename
        filename = f"sweep_{sweep_num:03d}_{current_temp:.1f}C_{timestamp_str}.csv"
        file_path = os.path.join(sweep_dir, filename)
        
        # Write to CSV
        with open(file_path, 'w', newline='') as csvfile:
            fieldnames = ['Point_Index', 'Sweep_Timestamp', 'Temperature_C', 'Frequency_Hz', 'Real_S11', 'Imag_S11', 'Current_Step']
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            writer.writeheader()
            
            for i in range(points_per_var):
                writer.writerow({
                    'Point_Index': i + 1,
                    'Sweep_Timestamp': collection_time.strftime('%Y-%m-%d %H:%M:%S'),
                    'Temperature_C': current_temp,
                    'Frequency_Hz': freq[i],
                    'Real_S11': real[i],
                    'Imag_S11': imag[i],
                    'Current_Step': current_step_idx
                })
        
        print(f"  [VNA] {collection_time.strftime('%H:%M:%S')} | +{elapsed_formatted} | Sweep #{sweep_num} @ {current_temp:.2f}¬∞C ‚Üí {filename}")
        return True
        
    except Exception as e:
        print(f"‚ùå VNA sweep error at step {current_step_idx}: {e}")
        return False

# --- 7. Ramp to Stability Function (PID Mode Only) ---
def ramp_to_stability(device, target_temp, stability_soak_s, ramp_timeout_s, 
                      csvwriter, csvfile, start_time, step_idx):
    """
    Ramps to target using Mode 0 PID, then holds for the soak time.
    
    Returns: True if stable/soak completed, False if timeout occurred.
    """
    
    # Ensure set to target temp in PID Mode 0
    device.set_temp(target_temp)
    
    print(f"üöÄ Ramping in Mode 0 (Fast PID): {device.get_temp():.1f}¬∞C ‚Üí {target_temp}¬∞C")
    
    stability_start_time = None
    ramp_start_time = time.time()
    
    print(f"‚è≥ Waiting for stability (¬±{TEMP_TOLERANCE}¬∞C) for the unified {stability_soak_s/60:.1f} min soak...")
    
    while True:
        
        if keyboard_interrupt_count > 0: return False 
            
        current_temp = device.get_temp()
        elapsed_ramp_time = time.time() - ramp_start_time
        
        # Check for Timeout
        if elapsed_ramp_time > ramp_timeout_s:
            print(f"‚ùå RAMP TIMEOUT! Failed to stabilize within {ramp_timeout_s/60:.1f} minutes.")
            
            # --- CRITICAL MANUAL OVERRIDE FLUSH ---
            if current_temp > target_temp: 
                print(f"   ‚ö†Ô∏è Temp too high. Initiating MAX COOLING FLUSH for {MANUAL_FLUSH_DURATION}s.")
                device.set_control_type(1) # Manual Output
                device.set_output(MAX_OUTPUT_COOLING) # -511
                time.sleep(MANUAL_FLUSH_DURATION)
                device.set_control_type(0) # Back to PID Control
                device.set_temp(target_temp) 
                print("   ‚úÖ MAX COOLING FLUSH complete. Switching back to PID Control.")
            
            return False # Timeout occurred
            
        # Check for Stability (The Unified Soak)
        if abs(current_temp - target_temp) <= TEMP_TOLERANCE:
            if stability_start_time is None:
                stability_start_time = time.time()
                print(f"   ‚úì Entered tolerance range at {current_temp:.2f}¬∞C. Starting stability/soak timer.")
                
            # If stable, check duration
            stable_duration = time.time() - stability_start_time
            if stable_duration >= stability_soak_s:
                print(f"‚úÖ Temperature stabilized at {current_temp:.2f}¬∞C (stable for {stable_duration:.1f}s)")
                return True # Successful stabilization/soak
                
        else:
            if stability_start_time is not None:
                print(f"   ‚úó Left tolerance range ({current_temp:.2f}¬∞C). Resetting stability/soak timer.")
            stability_start_time = None
            
        # Log temperature 
        current_time_str = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        elapsed_total_time = round(time.time() - start_time)
        elapsed_formatted = format_elapsed_time(elapsed_total_time)
        power = device.get_output()
        
        csvwriter.writerow({'Timestamp': current_time_str, 'Elapsed_Time_s': elapsed_total_time, 'Target_Temp_C': target_temp, 'Sensor_Temp_1_C': current_temp, 'Sensor_Temp_2_C': device.get_temp2(), 'Current_Step': step_idx, 'Note': 'PID_Ramp_or_Soaking'})
        csvfile.flush()
        print(f"  [TEMP] {current_time_str} | +{elapsed_formatted} | Target: {target_temp}¬∞C | Current: {current_temp:.2f}¬∞C | Power: {power:.1f}")

        time.sleep(SAMPLING_INTERVAL_SECONDS)

# --- 8. Main Data Collection Loop ---
def collect_data(device, vna, temps, stability_soak_s, ramp_timeout_s, exp_dir, sweep_dir):
    """Main data collection orchestration"""
    global experiment_start_time, vna_sweep_count, keyboard_interrupt_count
    
    vna_sweep_count = 0
    keyboard_interrupt_count = 0
    
    temp_log_file = os.path.join(exp_dir, "temperature_log.csv")
    
    # Metadata storage updated for PID Only mode
    metadata = {
        'experiment_start': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'temperature_targets': temps,
        'control_flow': 'PID Mode 0 Only (Python Time Control)',
        'stability_tolerance_C': TEMP_TOLERANCE,
        'unified_stability_soak_min': stability_soak_s / 60,
        'ramp_timeout_min': ramp_timeout_s / 60,
        'max_cooling_override_s': MANUAL_FLUSH_DURATION,
        'sweeps': []
    }
    
    with open(temp_log_file, 'w', newline='') as csvfile:
        fieldnames = ['Timestamp', 'Elapsed_Time_s', 'Target_Temp_C', 'Sensor_Temp_1_C', 'Sensor_Temp_2_C', 'Current_Step', 'Note']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        
        print(f"\nüöÄ Starting data collection. Temperature log: {temp_log_file}")
        
        start_time = time.time()
        experiment_start_time = start_time
        
        experiment_completed = False
        
        try:
            for step_idx, target_temp in enumerate(temps, 1):
                print(f"\n{'='*60}")
                print(f"STEP {step_idx}/{len(temps)}: Ramping to {target_temp}¬∞C")
                print(f"{'='*60}")
                
                # 1. Ramp and wait for stability (the unified soak)
                ramp_to_stability(
                    device, 
                    target_temp, 
                    stability_soak_s, 
                    ramp_timeout_s,
                    writer,
                    csvfile,
                    start_time,
                    step_idx
                )
                
                # 2. Perform Synchronous VNA Sweep (after stabilization/soak or timeout)
                current_temp_for_sweep = device.get_temp()
                print(f"\nüìä Performing synchronous VNA sweep...")
                perform_vna_sweep(vna, sweep_dir, current_temp_for_sweep, step_idx)
                
                # Log final point before moving on
                current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                elapsed_time = round(time.time() - start_time)
                
                writer.writerow({
                    'Timestamp': current_time,
                    'Elapsed_Time_s': elapsed_time,
                    'Target_Temp_C': target_temp,
                    'Sensor_Temp_1_C': current_temp_for_sweep,
                    'Sensor_Temp_2_C': device.get_temp2(),
                    'Current_Step': step_idx,
                    'Note': 'Sweep_Completed'
                })
                csvfile.flush()
                
                print(f"‚úÖ Step {step_idx} complete. Moving to next target.\n")
            
            experiment_completed = True
            print(f"\n{'='*60}")
            print(f"‚úÖ All temperature steps completed!")
            total_elapsed = time.time() - start_time
            print(f"‚è±Ô∏è  Total experiment time: {format_elapsed_time(total_elapsed)}")
            print(f"{'='*60}\n")
            
        except KeyboardInterrupt:
            print("\n‚ö†Ô∏è Experiment interrupted by user (Ctrl+C).")
            keyboard_interrupt_count = 1
        
        finally:
            try:
                device.set_idle()
                print("üîå TC-720 set to idle mode")
            except:
                pass
            
            metadata['experiment_end'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            metadata['total_sweeps'] = vna_sweep_count
            metadata['completed'] = experiment_completed
            
            metadata_file = os.path.join(exp_dir, "metadata.json")
            with open(metadata_file, 'w') as f:
                json.dump(metadata, f, indent=2)
            
            print(f"\nüìÅ Experiment data saved to: {exp_dir}")
    
    return experiment_completed

# --- 9. Main Execution ---
if __name__ == "__main__":
    print("\n" + "="*60)
    print("Synchronous Temperature-Stabilized Data Collection (PID Only Timing)")
    print("Flow: Ramp -> PID Stabilization for Soak Time -> Measure VNA -> Next Target")
    print("="*60)
    
    # Get initial inputs
    temps, stability_soak_min, ramp_timeout_min = get_temperature_profile()
    stability_soak_s = stability_soak_min * 60 
    ramp_timeout_s = ramp_timeout_min * 60

    # Initialize devices 
    print("\nüîß Initializing devices...")
    tc720, vna = initialize_devices()
    if tc720 is None or vna is None:
        print("‚ùå Device initialization failed. Exiting.")
        if tc720:
            tc720.set_idle()
        sys.exit(1)
    
    experiment_number = 0
    continue_experiments = True
    
    while continue_experiments:
        experiment_number += 1
        
        print(f"\n{'='*60}")
        print(f"EXPERIMENT #{experiment_number}")
        print(f"{'='*60}")
        
        # Setup directories for this experiment
        exp_dir, sweep_dir, timestamp = setup_experiment_directory()
        print(f"\nüìÅ Experiment directory: {exp_dir}")
        
        # Display configuration summary
        print(f"\nüìã Configuration Summary:")
        print(f"   Total Temperature targets: {len(temps)}")
        print(f"   Stability/Soak Criteria: PID Mode 0 will hold at ¬±{TEMP_TOLERANCE}¬∞C for {stability_soak_min} minutes (Python timed)")
        print(f"   Ramp Timeout: {ramp_timeout_min} minutes (w/ Max Cooling Flush)")
        
        input("\nPress Enter to start this experiment...")
        
        try:
            experiment_completed = collect_data(tc720, vna, temps, stability_soak_s, ramp_timeout_s, exp_dir, sweep_dir)
            
            print(f"\n{'='*60}")
            print(f"EXPERIMENT #{experiment_number} FINISHED")
            print(f"{'='*60}")
            
            if keyboard_interrupt_count > 0:
                print("\n‚ö†Ô∏è Previous experiment was interrupted.")
                print("Options:")
                print("  ‚Ä¢ Press Enter to start a NEW experiment")
                print("  ‚Ä¢ Press Ctrl+C again to EXIT the program")
                
                try:
                    input()
                    keyboard_interrupt_count = 0
                    continue
                except KeyboardInterrupt:
                    print("\n\n‚ö†Ô∏è Second interrupt received. Exiting program...")
                    continue_experiments = False
            else:
                print("\nOptions:")
                print("  ‚Ä¢ Press Enter to start a NEW experiment")
                print("  ‚Ä¢ Press Ctrl+C to EXIT the program")
                
                try:
                    input()
                    continue
                except KeyboardInterrupt:
                    print("\n\n‚ö†Ô∏è Exiting program...")
                    continue_experiments = False
        
        except Exception as e:
            print(f"\n‚ùå Unexpected error during experiment: {e}")
            print("Would you like to continue with a new experiment? (Press Enter to continue, Ctrl+C to exit)")
            try:
                input()
                continue
            except KeyboardInterrupt:
                print("\n\n‚ö†Ô∏è Exiting program...")
                continue_experiments = False
    
    try:
        if vna: vna.close()
        if tc720: tc720.set_idle()
    except: pass
    
    print(f"\n‚úÖ Program terminated. Total experiments run: {experiment_number}")
    print("="*60)